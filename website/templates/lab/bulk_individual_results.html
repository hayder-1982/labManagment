{% extends 'base.html' %}
{% load lab_filters %}
{% load widget_tweaks %}

{% block title %}إدخال نتائج التحاليل الفردية - نظام إدارة المختبرات الطبية{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="h3 mb-0">
    <i class="fas fa-flask me-2 text-primary"></i>
    إدخال نتائج التحاليل الفردية
  </h1>
  <a href="{% url 'test_request_detail' test_request.id %}" class="btn btn-outline-secondary rounded-pill">
    <i class="fas fa-arrow-right me-1"></i> العودة لتفاصيل الطلب
  </a>
</div>

<div class="row g-4">
  <!-- بيانات المريض -->
  <div class="col-lg-4">
    <div class="card shadow-sm border-0 rounded-3 mb-3">
      <div class="card-header bg-light">
        <h5 class="card-title mb-0">
          <i class="fas fa-user me-2 text-secondary"></i>
          معلومات المريض
        </h5>
      </div>
      <div class="card-body">
        <ul class="list-unstyled mb-0">
          <li><strong>الاسم:</strong> {{ test_request.patient.full_name }}</li>
          <li><strong>رقم الهوية:</strong> {{ test_request.patient.national_id }}</li>
          <li><strong>العمر:</strong> {{ test_request.patient.age }} سنة</li>
          <li><strong>الجنس:</strong> {{ test_request.patient.get_gender_display }}</li>
        </ul>
      </div>
    </div>

    <div class="card shadow-sm border-0 rounded-3">
      <div class="card-header bg-light">
        <h5 class="card-title mb-0">
          <i class="fas fa-info-circle me-2 text-secondary"></i>
          معلومات الطلب
        </h5>
      </div>
      <div class="card-body">
        <p><strong>رقم الطلب:</strong> #{{ test_request.id|stringformat:"s"|slice:":8" }}</p>
        <p><strong>تاريخ الطلب:</strong> {{ test_request.request_date|date:"Y/m/d" }}</p>
        <p><strong>الحالة:</strong>
          {% if test_request.status == 'pending' %}
            <span class="badge bg-warning text-dark">قيد الانتظار</span>
          {% elif test_request.status == 'in_progress' %}
            <span class="badge bg-info text-dark">قيد التنفيذ</span>
          {% elif test_request.status == 'completed' %}
            <span class="badge bg-success">مكتملة</span>
          {% elif test_request.status == 'cancelled' %}
            <span class="badge bg-danger">ملغية</span>
          {% endif %}
        </p>
      </div>
    </div>
  </div>

  <!-- إدخال النتائج -->
  <div class="col-lg-8">
    <div class="card shadow-sm border-0 rounded-3">
      <div class="card-header bg-light">
        <h5 class="card-title mb-0">
          <i class="fas fa-edit me-2 text-secondary"></i>
          إدخال النتائج
        </h5>
      </div>
      <div class="card-body">
        {% if form.get_test_fields %}
          <form method="post" class="needs-validation" novalidate>
            {% csrf_token %}
            <div class="alert alert-info small rounded-3 mb-4">
              <i class="fas fa-info-circle me-2"></i>
              أدخل القيم فقط للتحاليل المتوفرة، النظام سيحدد الحالة تلقائياً.
            </div>

            {% for test_field in form.get_test_fields %}
              <div class="border rounded-3 p-3 mb-3 bg-light-subtle">
                <!-- عنوان التحليل -->
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="mb-0">
                    <i class="fas fa-vial text-primary me-2"></i>
                    {{ test_field.test.name }}
                  </h6>
                  {% if test_field.existing_result %}
                    <span class="badge bg-info">محدث مسبقاً</span>
                  {% else %}
                    <span class="badge bg-secondary">جديد</span>
                  {% endif %}
                </div>

                <!-- حقول الإدخال -->
                <div class="row g-3 align-items-end">
                  <!-- القيمة -->
                  <div class="col-md-6">
                    <label class="form-label fw-bold">القيمة ({{ test_field.test.unit }})</label>
                    <div class="input-group input-group-lg">
                      {{ test_field.value_field }}
                      <span class="input-group-text text-muted small">
                        {{ test_field.test.normal_value_min }} - {{ test_field.test.normal_value_max }}
                      </span>
                    </div>
                    <div class="mt-1 small text-danger">{{ test_field.value_field.errors }}</div>
                  </div>

                  <!-- الملاحظات -->
                  <div class="col-md-6">
                    <label class="form-label small text-muted">ملاحظات</label>
                    {{ test_field.notes_field|add_class:"form-control-sm" }}
                    <div class="mt-1 small text-danger">{{ test_field.notes_field.errors }}</div>
                  </div>
                </div>

                <!-- بيانات إضافية -->
                {% if test_field.existing_result %}
                  <div class="mt-2 small text-muted">
                    <i class="fas fa-history me-1"></i>
                    آخر تحديث: {{ test_field.existing_result.result_date|date:"Y/m/d H:i" }}
                    - {{ test_field.existing_result.entered_by.username }}
                  </div>
                {% endif %}
              </div>
            {% endfor %}

            <!-- الأزرار -->
            <div class="d-flex justify-content-between mt-4">
              <a href="{% url 'test_request_detail' test_request.id %}" class="btn btn-outline-secondary rounded-pill">
                <i class="fas fa-times me-1"></i> إلغاء
              </a>
              <button type="submit" class="btn btn-success rounded-pill px-4">
                <i class="fas fa-save me-1"></i> حفظ النتائج
              </button>
            </div>
          </form>
        {% else %}
          <div class="alert alert-warning text-center rounded-3">
            <i class="fas fa-exclamation-triangle me-2"></i>
            لا توجد تحاليل فردية مرتبطة بهذا الطلب.
          </div>
          <div class="text-center">
            <a href="{% url 'test_request_detail' test_request.id %}" class="btn btn-outline-secondary rounded-pill">
              <i class="fas fa-arrow-right me-1"></i> العودة لتفاصيل الطلب
            </a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  function checkValue(input) {
    const value = parseFloat(input.value);
    const parent = input.closest(".border");
    parent.querySelectorAll(".badge-status").forEach(e => e.remove());

    if (!isNaN(value)) {
      // جلب الرينج من span (بدون اعتماد على وجود مسافات ثابتة)
      const rangeText = input.parentElement.querySelector("span").innerText;
      const range = rangeText.match(/([\d.]+)\s*-\s*([\d.]+)/);

      if (range) {
        const min = parseFloat(range[1]);
        const max = parseFloat(range[2]);

        let badge = document.createElement("span");
        badge.classList.add("badge", "ms-2", "badge-status");

        if (value < min) {
          badge.classList.add("bg-warning", "text-dark");
          badge.textContent = "منخفض";
        } else if (value > max) {
          badge.classList.add("bg-danger");
          badge.textContent = "مرتفع";
        } else {
          badge.classList.add("bg-success");
          badge.textContent = "طبيعي";
        }

        input.parentElement.appendChild(badge);
      }
    }
  }

  // تطبيق الفحص عند التحميل + التغيير
  document.querySelectorAll('input[type="number"]').forEach(input => {
    checkValue(input); // عند تحميل الصفحة
    input.addEventListener("input", function() {
      checkValue(this);
    });
  });
});
</script>

{% endblock %}
