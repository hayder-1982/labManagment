{% extends 'base.html' %}
{% block title %}إدخال نتائج مجموعات التحاليل{% endblock %}

{% block extra_css %}
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f8f9fc; }
.card { border-radius: 10px; box-shadow: 0 0.15rem 1.75rem rgba(58,59,69,0.15); margin-bottom: 1rem; }
.group-btn { width: 100%; text-align: left; margin-bottom: 0.5rem; }
.table { width: 100%; border-collapse: collapse; margin-bottom: 0; }
.table th, .table td { padding: 6px; font-size: 13px; vertical-align: middle; text-align: left; }
.table th { background-color: #e9ecef; }
.value-status { font-size: 0.85rem; font-weight: 600; margin-left: 5px; }
input[type="number"] { width: 100px; }
.patient-info { font-size: 12px; margin-bottom: 0.5rem; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">

    <!-- معلومات المريض -->
    <div class="card p-3 mb-3">
        <div class="row patient-info">
            <div class="col-6"><strong>اسم المريض:</strong> {{ test_request.patient.full_name }}</div>
            <div class="col-6"><strong>العمر:</strong> {{ test_request.patient.age }} سنة</div>
            <div class="col-6"><strong>الجنس:</strong> {{ test_request.patient.get_gender_display }}</div>
            <div class="col-6"><strong>الباركود:</strong> {{ test_request.patient.barcode }}</div>
        </div>
    </div>

    <!-- المجموعات -->
    {% for group_field in form.get_group_fields %}
        <button class="btn btn-outline-primary group-btn" type="button" data-bs-toggle="collapse" data-bs-target="#groupForm{{ forloop.counter }}">
            {{ group_field.group.name }} ({{ group_field.tests|length }} Tests)
        </button>

        <div class="collapse mb-3" id="groupForm{{ forloop.counter }}">
            <form method="post" class="card p-3 shadow-sm" dir="ltr" style="text-align: left;">
                {% csrf_token %}
                <table class="table table-sm table-striped table-bordered align-middle text-start">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 15%;">Test</th>
                            <th style="width: 15%;">Value</th>
                            <th style="width: 10%;">Unit</th>
                            <th style="width: 40%;">User</th>
                            <th style="width: 20%;">Note</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for test_field in group_field.tests %}
                            <tr>
                                <td>{{ test_field.test.name }}</td>
                                <td>
                                    <div class="input-group input-group-sm">
                                        {{ test_field.value_field }}
                                    </div>
                                    <span class="value-status text-muted small" id="status-{{ test_field.test.id }}"></span>
                                </td>
                                <td><small>({{ test_field.test.unit }})</small></td>
                                <td>
                                    {% if test_field.existing_result %}
                                        {% if test_field.existing_result.entered_by %}
                                            <div class="small text-muted">
                                                <i class="fas fa-user-edit"></i>
                                                Entered by:
                                                <strong>{{ test_field.existing_result.entered_by.username }}</strong>
                                                <br>
                                                {{ test_field.existing_result.result_date|date:"Y/m/d H:i" }}
                                            </div>
                                        {% endif %}
                                        
                                        {% if test_field.existing_result.last_modified_by %}
                                            <div class="small text-muted mt-1">
                                                <i class="fas fa-history"></i>
                                                Last modified by:
                                                <strong>{{ test_field.existing_result.last_modified_by.username }}</strong>
                                                <br>
                                                {{ test_field.existing_result.last_modified_at|date:"Y/m/d H:i" }}
                                            </div>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-secondary">New</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ test_field.notes_field }}
                                    {% if test_field.notes_field.errors %}
                                        <div class="text-danger small mt-1">
                                            {{ test_field.notes_field.errors }}
                                        </div>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <div class="mt-2 text-end">
                    <button type="submit" class="btn btn-success btn-sm">Save Group Results</button>
                </div>
            </form>
        </div>

    {% endfor %}

</div>
{% endblock %}

{% block extra_js %}
<script>
// تحديث الحالة عند إدخال القيم
document.addEventListener('DOMContentLoaded', function() {
    const valueInputs = document.querySelectorAll('input[type="number"]');
    valueInputs.forEach(input => {
        input.addEventListener('input', function() {
            const val = parseFloat(this.value);
            const statusEl = document.getElementById('status-' + this.id.split('_')[1]);
            if (!isNaN(val)) {
                const card = this.closest('tr');
                const rangeText = card.querySelector('td:nth-child(2) span')?.textContent || '';
                const match = rangeText.match(/(\d+\.?\d*)\s*-\s*(\d+\.?\d*)/);
                if (match) {
                    const min = parseFloat(match[1]), max = parseFloat(match[2]);
                    if (val < min) statusEl.innerHTML = '⬇ منخفض';
                    else if (val > max) statusEl.innerHTML = '⬆ مرتفع';
                    else statusEl.innerHTML = '✔ طبيعي';
                }
            } else { statusEl.innerHTML = ''; }
        });
    });
});
</script>
{% endblock %}
